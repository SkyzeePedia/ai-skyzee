<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SkyAI Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #343541; color: white; }
    .sidebar { background-color: #202123; width: 260px; display: flex; flex-direction: column; }
    .chat-container { background-color: #343541; height: calc(100vh - 100px); overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
    .chat-container::-webkit-scrollbar { width: 6px; }
    .chat-container::-webkit-scrollbar-thumb { background: #565869; border-radius: 3px; }
    .chat-bubble { max-width: 85%; padding: 15px; border-radius: 12px; margin-bottom: 12px; white-space: pre-wrap; word-wrap: break-word; }
    .user { background-color: #0d6efd; align-self: flex-end; color: white; }
    .bot { background-color: #444654; align-self: flex-start; color: white; position: relative; }
    .input-area { background-color: #343541; border-top: 1px solid #565869; padding: 15px; }
    .input-wrapper { display: flex; align-items: center; background: #40414f; border-radius: 12px; padding: 5px 10px; }
    #userInput { flex: 1; background: transparent; border: none; outline: none; color: white; padding: 10px; }
    #sendBtn { padding: 10px 15px; border-radius: 8px; }
    #sendBtn:disabled { background-color: #2d2d2d; color: #666; cursor: not-allowed; }
    #sendBtn:enabled { background-color: black; color: white; cursor: pointer; }
    .code-box { background: #0f172a; border-radius: 10px; margin-top: 8px; position: relative; overflow: hidden; border: 1px solid #2d3748; }
    .copy-btn, .preview-btn { position: absolute; top: 8px; font-size: 12px; padding: 4px 8px; border-radius: 6px; cursor: pointer; }
    .copy-btn { right: 8px; background: #1e293b; color: white; }
    .preview-btn { right: 80px; background: #2563eb; color: white; }
    pre { overflow-x: auto; padding: 12px; font-size: 14px; color: #d1d5db; }
    code { font-family: monospace; }
    .file-preview img { max-height: 100px; margin: 5px; border-radius: 8px; }
    /* Loading dots ala ChatGPT */
    .loading-dots span { animation: blink 1s infinite; }
    .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
    /* Responsif */
    @media(max-width: 768px){
      .sidebar { width: 60px; }
      .sidebar span { display: none; }
      .sidebar button span { display: none; }
    }
  </style>
</head>
<body class="flex h-screen">

  <!-- Sidebar -->
  <div class="sidebar p-4">
    <div class="flex items-center space-x-2 mb-4 text-white text-lg font-bold">
      <i class="fas fa-bars"></i>
      <span>SkyAI</span>
    </div>
    <button id="newChat" class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded mb-4">
      <i class="fas fa-plus mr-2"></i><span>New Chat</span>
    </button>
    <div class="text-gray-400 text-sm mb-2"><i class="fas fa-images mr-1"></i>Perpustakaan Foto</div>
    <div id="gallery" class="mt-2 grid grid-cols-2 gap-2"></div>
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col">
    <div class="chat-container" id="chatBox">
      <div class="bot chat-bubble">Apa yang bisa saya bantu?</div>
    </div>

    <!-- Input -->
    <div class="input-area">
      <div class="input-wrapper w-full">
        <input type="file" id="fileInput" class="hidden" multiple>
        <button onclick="document.getElementById('fileInput').click()" class="text-gray-400 mr-2"><i class="fas fa-paperclip"></i></button>
        <input type="text" id="userInput" placeholder="Ketik pesan..." autocomplete="off">
        <button id="sendBtn" disabled><i class="fas fa-paper-plane"></i></button>
      </div>
      <div class="file-preview flex p-2" id="filePreview"></div>
    </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script>
const apiBase = "https://apikey.skyzee.xyz/ai/chat-ai"; // endpoint kamu di server Node.js
const apikey = "skyzee";
const chatBox = document.getElementById('chatBox');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const fileInput = document.getElementById('fileInput');
const filePreview = document.getElementById('filePreview');
const gallery = document.getElementById('gallery');

// Enable/disable tombol kirim
userInput.addEventListener("input", () => {
  sendBtn.disabled = userInput.value.trim() === "";
});

// Typewriter effect
function typeWriter(element, text, speed = 20) {
  let i = 0;
  function typing() {
    if (i < text.length) {
      element.innerHTML += text.charAt(i);
      i++;
      setTimeout(typing, speed);
    } else {
      Prism.highlightAll();
    }
  }
  typing();
}

// Tambah bubble chat
function addMessage(text, sender="bot") {
  const div = document.createElement('div');
  div.className = `${sender} chat-bubble`;
  div.innerHTML = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  return div;
}

// Loading bubble ala ChatGPT
function addLoadingBubble() {
  const div = document.createElement('div');
  div.className = `bot chat-bubble`;
  div.innerHTML = `<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
  return div;
}

// Parse block kode
function parseCodeBlocks(text) {
  return text.replace(/```(\w+)?([\s\S]*?)```/g, (m, lang, code) => {
    lang = lang || 'markup';
    return `<div class="code-box mt-2 relative">
      <button class="copy-btn" onclick="navigator.clipboard.writeText(\`${code.trim()}\`)"><i class="fas fa-copy"></i> Copy</button>
      ${lang.toLowerCase() === 'html' ? `<button class="preview-btn" onclick="const w=window.open();w.document.write(\`${code.trim()}\`)"><i class="fas fa-eye"></i> Preview</button>` : ''}
      <pre><code class="language-${lang}">${code.trim().replace(/</g,'&lt;')}</code></pre>
    </div>`;
  });
}

// Kirim pesan
async function sendMessage() {
  const question = userInput.value.trim();
  if(!question) return;

  addMessage(question, "user");
  userInput.value = "";
  sendBtn.disabled = true;

  const loadingBubble = addLoadingBubble();

  try {
    const response = await fetch(`${apiBase}?apikey=${apikey}&question=${encodeURIComponent(question)}&model=deepseek-r1`);
    const data = await response.json();

    setTimeout(() => {
      loadingBubble.remove();
      const botBubble = addMessage("", "bot");
      typeWriter(botBubble, parseCodeBlocks(data.response || data.error || "Gagal mendapatkan jawaban."), 15);
    }, 2000);
  } catch (e) {
    loadingBubble.remove();
    addMessage("Gagal menghubungkan ke server.", "bot");
  }
}

// Event kirim
sendBtn.onclick = sendMessage;
userInput.addEventListener("keypress", e => { if(e.key==="Enter" && !sendBtn.disabled) sendMessage(); });

// Upload file preview
fileInput.addEventListener("change", e => {
  filePreview.innerHTML = "";
  Array.from(e.target.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      gallery.appendChild(img.cloneNode(true));
      filePreview.appendChild(img);
    }
    reader.readAsDataURL(file);
  });
});

// New Chat
document.getElementById('newChat').addEventListener('click', () => {
  chatBox.innerHTML = `<div class="bot chat-bubble">Apa yang bisa saya bantu?</div>`;
});
</script>
</body>
</html>
